/*
    Advanced YARA Rule for Malware Analysis
    Detects a wide range of suspicious behaviors in PE executable files
    Designed for Malware Analysts
    Date: March 14, 2025
*/

import "pe"  // Import PE module for additional PE file checks

rule Advanced_Malware_Analysis
{
    meta:
        description = "Detects suspicious PE files with potential malicious behaviors including obfuscation, packing, encryption, anti-debugging, polymorphism, code injection, and system manipulation"
        author = "Malware Analyst, with contributions from Grok (xAI)"
        date = "2025-03-14"
        version = "2.0"
        flexibility = "Adjustable conditions for sensitivity and specificity"

    strings:
        // Registry Manipulation - APIs and Suspicious Keys
        $reg1 = "RegCreateKey" ascii wide          // Create registry key
        $reg2 = "RegSetValue" ascii wide           // Set registry value
        $reg3 = "RegDeleteKey" ascii wide          // Delete registry key
        $reg4 = "RegOpenKey" ascii wide            // Open registry key
        $reg_susp1 = "Software\\Malicious" ascii wide  // Suspicious registry path
        $reg_susp2 = "Run" ascii wide              // Autorun key

        // Network Activity - APIs and Indicators
        $net1 = "InternetOpen" ascii wide          // Initialize internet
        $net2 = "HttpSendRequest" ascii wide       // Send HTTP request
        $net3 = "socket" ascii wide                // Socket creation
        $net4 = "WSAStartup" ascii wide            // Winsock initialization
        $net_susp1 = "http://" ascii               // Generic URL
        $net_susp2 = "ftp://" ascii                // FTP URL
        $net_susp3 = ".onion" ascii nocase         // Dark web indicator

        // File System Manipulation - APIs and Paths
        $file1 = "CreateFile" ascii wide           // Create/open file
        $file2 = "WriteFile" ascii wide            // Write to file
        $file3 = "DeleteFile" ascii wide           // Delete file
        $file4 = "CopyFile" ascii wide             // Copy file
        $file_susp1 = "\\System32\\" ascii wide    // System32 access
        $file_susp2 = "\\Temp\\" ascii wide        // Temp directory access
        $file_susp3 = ".dll" ascii nocase          // DLL file reference

        // Process and Execution - APIs and Commands
        $proc1 = "CreateProcess" ascii wide        // Create new process
        $proc2 = "ShellExecute" ascii wide         // Shell execution
        $proc3 = "WinExec" ascii wide              // Execute command
        $proc_susp1 = "cmd.exe" ascii wide         // Command prompt
        $proc_susp2 = "powershell.exe" ascii wide  // PowerShell

        // Common Malware Indicators
        $mal1 = "keylogger" ascii wide nocase      // Keylogger reference
        $mal2 = "backdoor" ascii wide nocase       // Backdoor reference
        $mal3 = "trojan" ascii wide nocase         // Trojan reference
        $mal4 = "ransomware" ascii wide nocase     // Ransomware reference

        // Code Obfuscation and Packing
        $pack1 = "UPX" ascii nocase                // Common packer
        $pack2 = "ASPack" ascii nocase             // Another packer
        $pack3 = "PECompact" ascii nocase          // Additional packer
        $pack4 = "Themida" ascii nocase            // Advanced protector
        $obf1 = "xor" ascii nocase                 // Simple obfuscation
        $obf2 = "rol" ascii nocase                 // Bit rotation
        $obf3 = "ror" ascii nocase                 // Reverse bit rotation
        $obf4 = "obfusc" ascii nocase              // Obfuscation keyword

        // Encryption Techniques
        $enc1 = "CryptEncrypt" ascii wide          // Windows API encryption
        $enc2 = "CryptDecrypt" ascii wide          // Windows API decryption
        $enc3 = "AES" ascii nocase                 // AES encryption
        $enc4 = "RSA" ascii nocase                 // RSA encryption
        $enc5 = "CryptGenKey" ascii wide           // Key generation
        $enc6 = "OpenSSL" ascii nocase             // OpenSSL library

        // Anti-Debugging Techniques
        $antidbg1 = "IsDebuggerPresent" ascii wide      // Debugger check
        $antidbg2 = "NtQueryInformationProcess" ascii wide // Process info
        $antidbg3 = "CheckRemoteDebuggerPresent" ascii wide // Remote debug
        $antidbg4 = "OutputDebugString" ascii wide      // Debug string trick
        $antidbg5 = "NtSetInformationThread" ascii wide // Hide thread

        // Polymorphism and Metamorphism
        $poly1 = "GetProcAddress" ascii wide       // Dynamic function loading
        $poly2 = "LoadLibrary" ascii wide          // Dynamic library loading
        $poly3 = "VirtualProtect" ascii wide       // Memory protection
        $poly4 = "VirtualAlloc" ascii wide         // Memory allocation
        $poly5 = "RtlMoveMemory" ascii wide        // Memory manipulation

        // Code Injection and Hooking
        $inj1 = "CreateRemoteThread" ascii wide    // Thread injection
        $inj2 = "WriteProcessMemory" ascii wide    // Memory writing
        $inj3 = "SetWindowsHookEx" ascii wide      // Windows hooking
        $inj4 = "QueueUserAPC" ascii wide          // APC injection
        $inj5 = "NtCreateThreadEx" ascii wide      // Advanced thread creation

    condition:
        // Basic PE file validation
        uint16(0) == 0x5A4D and                  // MZ header check
        pe.is_pe and                             // Ensure it's a PE file

        // Flexible detection logic
        (
            // High-confidence matches (2+ APIs + suspicious string)
            (2 of ($reg*) and 1 of ($reg_susp*)) or
            (2 of ($net*) and 1 of ($net_susp*)) or
            (2 of ($file*) and 1 of ($file_susp*)) or
            (2 of ($proc*) and 1 of ($proc_susp*)) or

            // Malware-specific indicators
            (1 of ($mal*) and 2 of ($reg*, $net*, $file*, $proc*)) or

            // Obfuscation or packing with system manipulation
            (1 of ($pack*, $obf*) and 2 of ($reg*, $net*, $file*, $proc*)) or

            // Advanced malicious techniques
            (2 of ($enc*, $antidbg*, $poly*, $inj*)) or

            // Broad suspicion across categories
            (1 of ($reg*, $net*, $file*, $proc*) and 
             1 of ($pack*, $obf*, $enc*) and 
             1 of ($antidbg*, $poly*, $inj*)) or

            // PE anomalies with suspicious behavior
            (pe.number_of_sections > 6 or pe.section_index(".upx") >= 0) and 
            (1 of ($reg*, $net*, $file*, $proc*, $pack*, $obf*))
        )
}